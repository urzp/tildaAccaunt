<style>
    .uc-incom, .uc-outcom{
        display: none;
    }
    .t-radio__control:has([value="cash"]){
        display: none;
    }
    .t706__form-bottom-text{
        margin-bottom: 0!important;
    }
</style>

<script>
    const URL_MAIN_PAGE = 'http://project6453667.tilda.ws/page42584837.html'
    const URL_READ_USER = 'https://lktilda.ru/php/readUser.php'
    const URL_UPDATE_USER = 'https://lktilda.ru/php/updateUser.php'
    const URL_UPDATE_PASSWORD = 'https://lktilda.ru/php/updatePassword.php'
    let user, payments

    async function intUserPanel(){
        userinf = await loadUser()
        user = await userinf.user
        payments = await userinf.payments
        fillBalans(user)
        setButtons()
        initPassword_Zinputs()
        whaitRendered('uc-user_data', ()=>{fillFormUser(user)}) 
        await fillFormCard(user)
        fillPaymentTabele(payments)
        showSuccsessPupap()
        $('.t706__orderform [value="cash"]').parent().remove()
    }

    // ------------------  функции url запросов ------------------------
    async function loadUser(){
        let i=0
        let reuslt = false
        while (!reuslt&&i<3){
            reuslt = await getUserInf()
            i++;
        }
        if(!reuslt) window.location.replace(URL_MAIN_PAGE)
        return reuslt
    }

    async function getUserInf(){
        let content = {
            email: localStorage.email,
            token: localStorage.token,            
        }
        
        let result = await ajaxReq(URL_READ_USER, AJAX_OPTIONS, content)
        if(!result.success){ return false }
        return result
    }

    // ------------------  функции рендеринга и заполнения полей ------------------------
    async function updatePassword(){
        let content = {
            id:  $(`.userInf [name="user_id"]` ).val(),
            old_password:  $(`.password [name="old_password"]` ).val(),
            new_password:  $(`.password [name="new_password"]` ).val(),
            token: localStorage.token,            
        }    
        let result = await ajaxReq(URL_UPDATE_PASSWORD, AJAX_OPTIONS, content)
        return result
    }

    async function updateUser(){
        let content = {
            id:  $(`.userInf [name="user_id"]` ).val(),
            email:  $(`.userInf [name="email"]` ).val(),
            name:  $(`.userInf [name="name"]` ).val(),
            token: localStorage.token,            
        }    
        let result = await ajaxReq(URL_UPDATE_USER, AJAX_OPTIONS, content)
        return result
    }

    async function fillFormUser(user){
        $(`.userInf [name="email"]` ).val(user.email)
        $(`.userInf [name="name"]` ).val(user.name)
        $(`.userInf [name="user_id"]` ).val(user.id)
        
    }

    async function fillFormCard(user){
        $('.t706__orderform [name="id_user"]').val(user.id)
        $('.t706__orderform [name="email"]').val(user.email)
        $('.t706__cartwin-heading').text(`Ваш баланс: ${user.balans} р.`)
    }
    function fillBalans(user){
        $('.balans .tn-atom').text(user.balans + ' p.')
    }
    // заполнение таплиц расходов приходов
    function fillPaymentTabele(data){
        if(!data) return false
        data.forEach( (element, i) => {
            $('.in_payment_table').append(html_row)
            $('.in_payment_table .row_').addClass(`row_${i}`).removeClass('row_')
            $(`.in_payment_table .row_${i} .column_1 .text`).text(element.datetime)
            $(`.in_payment_table .row_${i} .column_2 .text`).text(element.paymentsystem)
            $(`.in_payment_table .row_${i} .column_3 .text`).text(element.trnsaction)
            $(`.in_payment_table .row_${i} .column_4 .text`).html(`${element.sum} <span> p.</span>`)
        });
        $('.uc-incom').css({'display':'block','opacity':'0.01'})
        whaitRendered('uc-incom',function(){
            ajastBG('in_paymentBG', 'in_payment_table', bottumGap)
        })
        
    }

    function ajastBG(BGClassName, classNameTable, setBottumGap){
        let buttomBG = $(`.${BGClassName}`).offset().top + $(`.${BGClassName}`).height()
        let buttomTable = $(`.${classNameTable}`).offset().top + $(`.${classNameTable}`).height()
        let gap = buttomBG - buttomTable
        let newHiegthBG = $(`.${BGClassName}`).height() + setBottumGap - gap
        $(`.${BGClassName}`).height(newHiegthBG)
        let newHiegthZero = $(`.${BGClassName}`).parents('.t396__artboard').height() + setBottumGap - gap
        $(`.${BGClassName}`).parents('.t396__artboard').height(newHiegthZero)
        $('.uc-incom').animate({opacity:1.0},500)
    }

    function whaitRendered(classNameZBl, callBack){
        let idInterval = setInterval(()=>{
            let rendered = $(`.${classNameZBl} .t396__artboard`).hasClass('rendered')
            if(!rendered) return false
            clearInterval(idInterval)
            callBack()
        },300)
    }

    // ------------------  функции обработки кликов и событий ------------------------
    function setButtons(){
        $('.userInf .t-submit, password .t-submit').click( function(event){
            event.stopPropagation()
        })

        $('.saveUserInfBtn').click(async()=>{
            resetErrors_Zform('userInf')
            if(!checkEmpty_Zform('userInf','email')) return false
            if(!checkEmail_Zform('userInf','email')) return false
            if(!checkEmpty_Zform('userInf','name')) return false
            let result = await updateUser()
            if(!result.success&&result.msg=='email') setError_Zform('userInf','email', 'email занят')
            if(result.success){
                localStorage.email = $(`.userInf [name="email"]`).val()
                $('.uc-user_menu .email .tn-atom').text(localStorage.email)
                t390_showPopup(getIdPupap('updatesuccsess'))
            } 
        })

        $('.savePasswordBtn').click(async()=>{
            resetErrors_Zform('password')
            if(!checkEmpty_Zform('password','old_password')) return false
            if(!checkEmpty_Zform('password','new_password')) return false
            if(!checkEmpty_Zform('password','new_password_check')) return false
            if(!checkPasswords_Zform('password', 'new_password', 'new_password_check')) return false
            let result = await updatePassword()
            if(!result.success&&result.msg=='password') setError_Zform('password','old_password', 'неверный пароль')
        })
    }

    function setEvents(){
        $( 'input' ).on( "focus", function() {
            resetErrors_Zform('password')
        });
    }

    function showSuccsessPupap(){
        if(document.URL.split('/').pop().split('#').pop()!='paymentsuccsess') return false
        t390_showPopup(getIdPupap('paymentsuccsess'))
    }

     // ------------------  функции проверки полей зероблоков------------------------

     function initPassword_Zinputs(){
        $('[name="old_password"]').attr({'type':'password'})
        $('[name="new_password"]').attr({'type':'password'})
        $('[name="new_password_check"]').attr({'type':'password'})
     }

    function resetErrors_Zform(nameForm){
        $(`.${nameForm} .js-error-control-box`).removeClass('js-error-control-box')
    }

     function checkEmpty_Zform(nameForm, nameFeld){
        if(!!$(`.${nameForm} [name="${nameFeld}"]`).val()) return true
        setError_Zform(nameForm, nameFeld, 'Поле не должно быть пустым')
        return false 
     }

     function checkPasswords_Zform(nameForm, nameFeld_1, nameFeld_2){
        if($(`.${nameForm} [name="${nameFeld_1}"]`).val()==$(`.${nameForm} [name="${nameFeld_2}"]`).val()) return true
        setError_Zform(nameForm, nameFeld_1, 'Пароли не совпали')
        return false 
     }

     function checkEmail_Zform(nameForm, nameFeld){
        if(cheEmail($(`.${nameForm} [name="${nameFeld}"]`).val())) return true
        setError_Zform(nameForm, nameFeld, 'Неккоректный email')
        return false 
     }

     function setError_Zform(nameForm, nameFeld, msg){
        $(`.${nameForm} [name="${nameFeld}"]`).parent().parent().addClass('js-error-control-box')
        $(`.${nameForm} [name="${nameFeld}"]`).parent().find('.t-input-error').text(msg)     
     }

     function cheEmail(email){
    return String(email)
        .toLowerCase()
        .match(
        /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|.(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
        );
    };
</script>