<style>
    .uc-incom, .uc-outcom{
        display: none;
    }
</style>

<script>
    const URL_MAIN_PAGE = 'http://project6453667.tilda.ws/page42584837.html'
    const URL_READ_USER = 'https://lktilda.ru/php/readUser.php'
    const URL_UPDATE_USER = 'https://lktilda.ru/php/updateUser.php'
    const URL_UPDATE_PASSWORD = 'https://lktilda.ru/php/updatePassword.php'
    let user

    async function intUserPanel(){
        user = await loadUser()
        fillBalans(user)
        setButtons()
        initPassword_Zinputs()
        await fillFormUser(user)
        await fillFormCard(user)
        $('.uc-incom').css({'display':'block'})
    }

    async function loadUser(){
        let i=0
        let reuslt = false
        while (!reuslt&&i<3){
            reuslt = await getUserInf()
            i++;
        }
        if(!reuslt) window.location.replace(URL_MAIN_PAGE)
        return reuslt
    }

    async function getUserInf(){
        let content = {
            email: localStorage.email,
            token: localStorage.token,            
        }
        
        let result = await ajaxReq(URL_READ_USER, AJAX_OPTIONS, content)
        if(!result.success){ return false }
        return result.user
    }

    async function updatePassword(){
        let content = {
            id:  $(`.userInf [name="user_id"]` ).val(),
            old_password:  $(`.password [name="old_password"]` ).val(),
            new_password:  $(`.password [name="new_password"]` ).val(),
            token: localStorage.token,            
        }    
        let result = await ajaxReq(URL_UPDATE_PASSWORD, AJAX_OPTIONS, content)
        return result
    }

    async function updateUser(){
        let content = {
            id:  $(`.userInf [name="user_id"]` ).val(),
            email:  $(`.userInf [name="email"]` ).val(),
            name:  $(`.userInf [name="name"]` ).val(),
            token: localStorage.token,            
        }    
        let result = await ajaxReq(URL_UPDATE_USER, AJAX_OPTIONS, content)
        return result
    }

    async function fillFormUser(user){
        $(`.userInf [name="email"]` ).val(user.email)
        $(`.userInf [name="name"]` ).val(user.name)
        $(`.userInf [name="user_id"]` ).val(user.id)
        
    }

    async function fillFormCard(user){
        $('.t706__orderform [name="id_user"]').val(user.id)
        $('.t706__orderform [name="email"]').val(user.email)
        $('.t706__cartwin-heading').text(`Ваш баланс: ${user.balans} р.`)
    }
    function fillBalans(user){
        $('.balans .tn-atom').text(user.balans + ' p.')
    }

    function setButtons(){
        $('.userInf .t-submit, password .t-submit').click( function(event){
            event.stopPropagation()
        })

        $('.saveUserInfBtn').click(async()=>{
            resetErrors_Zform('userInf')
            if(!checkEmpty_Zform('userInf','email')) return false
            if(!checkEmail_Zform('userInf','email')) return false
            if(!checkEmpty_Zform('userInf','name')) return false
            let result = await updateUser()
            if(!result.success&&result.msg=='email') setError_Zform('userInf','email', 'email занят')
            if(result.success){
                localStorage.email = $(`.userInf [name="email"]`).val()
                $('.uc-user_menu .email .tn-atom').text(localStorage.email)
                t390_showPopup(getIdPupap('updatesuccsess'))
            } 
        })

        $('.savePasswordBtn').click(async()=>{
            resetErrors_Zform('password')
            if(!checkEmpty_Zform('password','old_password')) return false
            if(!checkEmpty_Zform('password','new_password')) return false
            if(!checkEmpty_Zform('password','new_password_check')) return false
            if(!checkPasswords_Zform('password', 'new_password', 'new_password_check')) return false
            let result = await updatePassword()
            if(!result.success&&result.msg=='password') setError_Zform('password','old_password', 'неверный пароль')
        })
    }

    function setEvents(){
        $( 'input' ).on( "focus", function() {
            resetErrors_Zform('password')
        });
    }

     // ------------------  функции проверки полей зероблоков------------------------

     function initPassword_Zinputs(){
        $('[name="old_password"]').attr({'type':'password'})
        $('[name="new_password"]').attr({'type':'password'})
        $('[name="new_password_check"]').attr({'type':'password'})
     }

    function resetErrors_Zform(nameForm){
        $(`.${nameForm} .js-error-control-box`).removeClass('js-error-control-box')
    }

     function checkEmpty_Zform(nameForm, nameFeld){
        if(!!$(`.${nameForm} [name="${nameFeld}"]`).val()) return true
        setError_Zform(nameForm, nameFeld, 'Поле не должно быть пустым')
        return false 
     }

     function checkPasswords_Zform(nameForm, nameFeld_1, nameFeld_2){
        if($(`.${nameForm} [name="${nameFeld_1}"]`).val()==$(`.${nameForm} [name="${nameFeld_2}"]`).val()) return true
        setError_Zform(nameForm, nameFeld_1, 'Пароли не совпали')
        return false 
     }

     function checkEmail_Zform(nameForm, nameFeld){
        if(cheEmail($(`.${nameForm} [name="${nameFeld}"]`).val())) return true
        setError_Zform(nameForm, nameFeld, 'Неккоректный email')
        return false 
     }

     function setError_Zform(nameForm, nameFeld, msg){
        $(`.${nameForm} [name="${nameFeld}"]`).parent().parent().addClass('js-error-control-box')
        $(`.${nameForm} [name="${nameFeld}"]`).parent().find('.t-input-error').text(msg)     
     }

     function cheEmail(email){
    return String(email)
        .toLowerCase()
        .match(
        /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|.(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
        );
    };
</script>