<!-- Обработка login regisration -->
<style>
    [data-tooltip-hook="#popup:login"] .js-successbox{
        display:none!important
    }
</style>

<script>
    const AJAX_OPTIONS = {
        type: 'POST',
        headers: { 'Content-Type': 'application/json;charset=utf-8' },
    }
    const URL_IS_LOGIN = 'https://lktilda.ru/php/isLogget.php'
    const URL_CHECK_EMAIL = 'https://lktilda.ru/php/isHasEmail.php'
    const URL_GET_BALANS = 'https://lktilda.ru/php/getBalans.php'

    let checkFelds = true

    $( document ).ready(function() {
        renderHideAll()
        initPasswordInputs()
        setButtonsEvents()
        checkAfterSendLogin(initMenu)
    });




    // ------------------ обработка события кликов ------------------------

    function setButtonsEvents(){
        $(`.t978__link-inner.t978__link-inner_left:contains("Войти")`).click(()=>{
            let token = generateToken()
            localStorage.token = token
            $('[data-tooltip-hook="#popup:login"] [name="login_token"]').val(token)
        })

        $(`.t978__link-inner.t978__link-inner_left:contains("Выйти")`).click(()=>{
            logout()
        })

        $('[data-tooltip-hook="#popup:registration"] .t-submit').click(async function(event){
            if(!checkFelds) return false
            if(!checkPasswords(event)) return false
            if(!await checkEmail(event)) return false
        })

        $('[data-tooltip-hook="#popup:login"] .t-submit').click(()=>{
            localStorage.email = $('[data-tooltip-hook="#popup:login"] [name="email"]').val()
            whaitResponseForm('login')
        })

    }

    // ------------------ вспомогательные функции ------------------------

    function hideMenuItem(content){
        $(`.t978__link-inner.t978__link-inner_left:contains(${content})`).parent().parent().fadeOut()
    }
    function showMenuItem(content){
        $(`.t978__link-inner.t978__link-inner_left:contains(${content})`).parent().parent().fadeIn()
    }

    function checkSendForm(name){
        return $(`[data-tooltip-hook="#popup:${name}"] form`).hasClass('js-send-form-success')
    }

    function getIdPupap(name){
        let id = $(`[data-tooltip-hook="#popup:${name}"]`).parent().parent().attr('id')
        return id.split('rec')[1]
    }

    function pupapTitle(pupapName, title, addTitle=false){
        let text = $(`[data-tooltip-hook="#popup:${pupapName}"] .t390__title.t-heading.t-heading_lg`).text()
        if(addTitle) title = text + title
        $(`[data-tooltip-hook="#popup:${pupapName}"] .t390__title.t-heading.t-heading_lg`).text(title)
    }

    async function ajaxReq(url, options, content){
        let response = await fetch(url,{
            method: options.type,
            headers: options.heders,
            body: JSON.stringify(content)
        })
        return await response.json();
    }

    async function getBalans(){
        let content = {
            email: localStorage.email,
            token: localStorage.token,            
        }
        let result = await ajaxReq(URL_GET_BALANS, AJAX_OPTIONS, content)
        console.log(result)
        if(!result.success){
            return 'баланс не определен'
        }else{
            return `${result.balans} р.`
        }
    }

    function generateToken(){
        var rand = function() {
            return Math.random().toString(36).substr(2); // remove `0.`
        };

        var token = function() {
            return rand() + rand(); // to make it longer
        };
        return token()
    }

    // ------------------  функции рендренга ------------------------

    function initPasswordInputs(){
        $('[name="password"]').attr({'type':'password'})
        $('[name="password_check"]').attr({'type':'password'})
    }

    function initMenu(){
        isLogget().then((result)=>{
            if(result){
                renderLogin()
            }else{
                renderLogOut()
            }
        })
    }

    async function renderLogin(){
        hideMenuItem("Войти")
        hideMenuItem("Регистрация")
        showMenuItem("Выйти")
        $('.uc-user_menu .email .tn-atom').text(localStorage.email)
        $('.uc-user_menu .balans .tn-atom').text(await getBalans())
    }

    function renderLogOut(){
        showMenuItem("Войти")
        showMenuItem("Регистрация")
        hideMenuItem("Выйти")
        $('.uc-user_menu .email .tn-atom').text('')
        $('.uc-user_menu .balans .tn-atom').text('')
    }

    function renderHideAll(){
        hideMenuItem("Войти")
        hideMenuItem("Регистрация")
        hideMenuItem("Выйти")
        hideMenuItem("loader")
    }

    // ------------------  функции проверки полей ------------------------
    function checkPasswords(event){
        let password = $('[data-tooltip-hook="#popup:registration"] [name="password"]').val()
        let password_check = $('[data-tooltip-hook="#popup:registration"] [name="password_check"]').val()
        if(password!=password_check ){
            $('[data-tooltip-hook="#popup:registration"] [name="password"]').parent().parent().addClass('js-error-control-box')
            $('[data-tooltip-hook="#popup:registration"] [name="password_check"]').parent().parent().addClass('js-error-control-box')
            $('[data-tooltip-hook="#popup:registration"] .js-rule-error-name').text('Пароли должны совподать')
            $('[data-tooltip-hook="#popup:registration"] .js-rule-error-name').css({'display':'block'})
            $('[data-tooltip-hook="#popup:registration"] .t-form__errorbox-wrapper').css({'display':'block'})
            event.stopPropagation()
            return false
        }
        return true
    }

    async function checkEmail(event){
        event.stopPropagation()
        let email = $('[data-tooltip-hook="#popup:registration"] [name="email"]').val()
        let result = await ajaxReq(URL_CHECK_EMAIL, AJAX_OPTIONS, {email})
        if(result ){
            $('[data-tooltip-hook="#popup:registration"] [name="email"]').parent().parent().addClass('js-error-control-box')
            $('[data-tooltip-hook="#popup:registration"] .js-rule-error-name').text(`${email} уже заорегестрирован`)
            $('[data-tooltip-hook="#popup:registration"] .js-rule-error-name').css({'display':'block'})
            $('[data-tooltip-hook="#popup:registration"] .t-form__errorbox-wrapper').css({'display':'block'})
        }else{
            console.log('pass')
            event.returnValue = true
            checkFelds = false
            $('[data-tooltip-hook="#popup:registration"] .t-submit').click()
            return true
        }
        
    }

    // ------------------  функции сценария ------------------------

    function reloadPageWithRerult(){
        localStorage.afterSendLogin = true
        location.reload();
    }

    function checkAfterSendLogin(callBack){
        if(!localStorage.afterSendLogin){
            callBack()
            return false
        } 
        delete localStorage.afterSendLogin
        setTimeout(()=>{$(`.t978__link-inner.t978__link-inner_left:contains('loader')`).click()},500)
        
        isLogget(true).then((result)=>{
            if(result){
                t390_closePopup(getIdPupap('loader'))
                pupapTitle('loginsuccess', " " + localStorage.email, true)
                t390_showPopup(getIdPupap('loginsuccess'))
                renderLogin()
            }else{
                t390_closePopup(getIdPupap('loader'))
                t390_showPopup(getIdPupap('denied'))
                renderLogOut()
            }
        })      
    }

    async function isLogget(wait_for_update=false){
        if(!localStorage.email||!localStorage.token) return false
        let content = {
            email: localStorage.email,
            token: localStorage.token,
            wait_for_update,
        }
        let result = await ajaxReq(URL_IS_LOGIN, AJAX_OPTIONS, content)
        return result
    }

    function logout(){
        delete localStorage.email
        delete localStorage.token
        renderLogOut()
    }

    function whaitResponseForm(name){
        let id_inteval = setInterval(()=>{
            if( checkSendForm('login') ){
                clearInterval(id_inteval)
                $('.t-popup__block-close-button').click()
                reloadPageWithRerult()
            }
        },300)
    }

</script>

