<!-- Исправление проблемы с отправкой поля quntity  -->

<script>
    let card_data
    let URL_UPDATE_PAGES = 'https://smmbackmy.ru/php/getCards.php'

    $(document).ready(function(){
        fixQuntity()
    })

    async function fixQuntity(){
        awaitElement(".t706__orderform form", addFild)
        awaitElement(".t706__product-quantity", bindFilds)
        data = {id_page: $('#allrecords').attr('data-tilda-page-id') }
        card_data = await ajaxReq(URL_UPDATE_PAGES, AJAX_OPTIONS, data)
        bindCards()
    }

    function awaitElement(jquery_selctor, callback){
        let id_timer = setInterval(()=>{
            if($(jquery_selctor).length>0){
                clearInterval(id_timer)
                callback()
            }
        },300)      
    }

    function addFild(){
        let html_fild = `<input type="hidden" name="quantity" value="">`
        $(".t706__orderform form").append(html_fild)
        html_fild = `<input type="hidden" name="service" value="">`
        $(".t706__orderform form").append(html_fild)
        html_fild = `<input type="hidden" name="prodavec_id" value="">`
        $(".t706__orderform form").append(html_fild)
        html_fild = `<input type="hidden" name="type" value="">`
        $(".t706__orderform form").append(html_fild)
        //console.log('add fild');
    }

    function bindCards(){
        $(".t1070__col").each(function (i) {
            let card = card_data.data[i]
            $(this).attr("id", card.id_servis)
            $(this).attr("pr_id", card.id_provider)
        })
        $(".t1070__col a").each(function () {     
            this.onclick = () =>{   
                let id = event.target.closest(".t1070__col").getAttribute("id")
                document.querySelector('input[name="service"]').setAttribute("value", id) 
                let pr_id = event.target.closest(".t1070__col").getAttribute("pr_id")
                document.querySelector('input[name="prodavec_id"]').setAttribute("value", pr_id) 
            }   
        }); 
    }

    function bindFilds(){
        //console.log('bind')
        $(`.t706__orderform form [name="quantity"]`).val($('.t706__product-quantity').text())
        $('.t706__product-quantity').on('DOMSubtreeModified', function(){
            $(`.t706__orderform form [name="quantity"]`).val($('.t706__product-quantity').text())
        })
    }
</script>